rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ---------------- helpers ----------------
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return isSignedIn() && request.auth.token.role == "admin"; }
    function isManager() { return isSignedIn() && request.auth.token.role == "manager"; }
    function isAdminOrManager() { return isAdmin() || isManager(); }
    function isRoomParticipant(roomId) {
      return isSignedIn() && exists(/databases/$(database)/documents/rooms/$(roomId))
        && (request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants);
    }
    function isRoomOwner(roomId) {
      return isSignedIn() && exists(/databases/$(database)/documents/rooms/$(roomId))
        && get(/databases/$(database)/documents/rooms/$(roomId)).data.created_by == request.auth.uid;  // Изменил на created_by, как в ТЗ
    }

    // ---------------- users_public ----------------
    match /users_public/{userId} {
      allow read: if true;
      allow create, update: if request.auth.uid == userId || isAdminOrManager();
      allow delete: if isAdmin();
    }

    // ---------------- users_private ----------------
    match /users_private/{userId} {
      allow read: if isAdminOrManager() || request.auth.uid == userId;
      allow create, update: if request.auth.uid == userId || isAdminOrManager();
      allow delete: if isAdmin();
    }

    // ---------------- rooms ----------------
    match /rooms/{roomId} {
      allow read: if isSignedIn() &&
          (request.auth.uid in resource.data.participants ||
              resource.data.created_by == request.auth.uid ||
              isAdmin());

      allow create: if isSignedIn() &&
          isAdminOrManager() &&
          request.resource.data.keys().hasAll(["title", "created_by", "participants", "status"]) &&
          request.resource.data.created_by == request.auth.uid &&
          request.auth.uid in request.resource.data.participants;

      allow update: if isSignedIn() &&
          (isAdmin() ||
              (isManager() && resource.data.created_by == request.auth.uid));

      allow delete: if isSignedIn() &&
          (isAdmin() || (isManager() && resource.data.created_by == request.auth.uid));

      match /messages/{messageId} {
        allow read, create: if isRoomParticipant(roomId) || isAdmin();

        allow update: if isRoomParticipant(roomId) &&
            request.auth.uid == resource.data.author_id &&
            request.time < resource.data.created_at + duration.value(15, "m") &&
            request.resource.data.diff(resource.data).changedKeys().hasOnly(["text", "edited_at"])

        allow delete: if request.auth.uid == resource.data.author_id || isAdmin();
      }
    }

    // ---------------- direct_messages ----------------
    // DMs: pair uid1_uid2 (sorted)
    match /direct_messages/{dmId} {
      function isDmParticipant() {
        let uids = dmId.split('_');
        return request.auth.uid in uids;
      }
      allow read: if isDmParticipant();
      allow create: if isAdminOrManager();  // Only senders
      allow update, delete: if isAdmin();  // No user edits
    }

    // ---------------- audits ----------------
    match /audits/{docId} {
      allow create: if isAdmin();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // ---------------- files ----------------
    match /files/{fileId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdminOrManager();
    }

    // default deny
    match /{document=**} { allow read, write: if false; }
  }
}